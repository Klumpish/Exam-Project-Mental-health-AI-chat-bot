# Docker Compose file for running PostgreSQL locally
# For an easy start database for development
# Run with: docker-compose up -d


services:
    # PostgreSQL database
    postgres:
        image: postgres:15-alpine
        container_name: ${DB_CONTAINER_NAME:-mental_health_dev_db}
        environment:
            # Database credentials
            #These have to be the same in both, application.properties in /backend
            POSTGRES_DB: ${DB_NAME:-mental_health_dev_db}
            POSTGRES_USER: ${DB_USERNAME:-dev_user}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password}
        ports:
            # Expose PostgreSQL on localhost:5432
            - "5432:5432"
        volumes:
            # Persist database data
            - postgres_data:/var/lib/postgresql/data
        networks:
            - chatbot_network
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U dev_user -d mental_health_dev_db" ]
            interval: 10s
            timeout: 5s
            retries: 5

    #Backend (spring boot)
    backend:
        build:
            context: ./backend/backend
            dockerfile: Dockerfile
        container_name: mental_health_backend
        environment:
            DB_URL: jdbc:postgresql://postgres:5432/${DB_NAME:-mental_health_dev_db}
            DB_USERNAME: ${DB_USERNAME:-dev_user}
            DB_PASSWORD: ${DB_PASSWORD:-dev_password}
            GPT4ALL_API_URL: http://host.docker.internal:4891/v1
            GPT4ALL_MODEL_NAME: Mistral Instruct
            AI_MAX_TOKENS: 150
            AI_TEMPERATURE: 0.7
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: 86400000
            SERVER_PORT: 8080
            CORS_ALLOWED_ORIGINS: http://localhost:3000
        ports:
            - "8080:8080"
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - chatbot_network
        restart: unless-stopped

    #Frontend (next.js)
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        container_name: mental_health_frontend
        environment:
            NEXT_PUBLIC_API_URL: http://localhost:8080
        ports:
            - "3000:3000"
        depends_on:
            - backend
        networks:
            - chatbot_network
        restart: unless-stopped

    
    # (Optional) pgAdmin for database management UI
    pgAdmin:
        image: dpage/pgadmin4:latest
        container_name: ${DB_PGADMIN_NAME:-pgAdmin_dev}
        environment:
            #TODO change in prod
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
        ports:
            - "5050:80"
        networks:
            - chatbot_network
        depends_on:
            - postgres

# Define volumes for data persistence
volumes:
    postgres_data:

# Define network for services to communicate
networks:
    chatbot_network:
        driver: bridge
